# ШБР Лето 2023. Вступительное задание

Вы устроились в Яндекс и запускаете сервис Яндекс Лавка. Ваша первая задача - разработать новый REST API сервис,
который будет отвечать за регистрацию курьеров, добавление новых заказов и их распределение по курьерам.

## Требования к сервису

1) реализовано REST API сервиса (детали в разделе Задание 1) - обязательное задание
2) реализован расчет рейтинга курьеров (детали в разделе Задание 2)
3) реализованы rate limits для сервиса (детали в разделе Задание 3)
4) реализован алгоритм распределения заказов по курьерам (детали в разделе Задание 4)

## Правила оценки работы

Задание 1 является обязательным. Задания 2, 3 и 4 могут быть выполнены независимо и в любых вариациях.

## Задание 1. REST API

В рамках задания необходимо реализовать 7 базовых эндпоинтов нашего нового сервиса.

Для всех методов в случае корректного ответа ожидается ответ `HTTP 200 OK`.

### POST /couriers
Данный метод используется для загрузки списка курьеров в систему.

Обработчик принимает на вход список с данными о курьерах и графиком их работы в формате json.

Курьеры работают только в заранее определенных районах, а также различаются по типу: пеший, велокурьер и курьер 
на автомобиле. От типа курьера может зависеть объем заказов, которые перевозит курьер.

Районы задаются целыми положительными числами. График работы задается списком строк формата `HH:MM-HH:MM`.

### GET /couriers/{courier_id}

Метод для получения информации о курьере по id.

### GET /couriers

Метод возвращает информацию о всех курьерах.

У метода есть параметры `offset` и `limit` для обеспечения постраничной выдачи:
* в случае, если `offset` и `limit` не передаются, считать по умолчанию `offset=0`, `limit=1`
* в случае, если сущностей по заданным `offset` и `limit` не найдено, то необходимо возвращать пустой список `couriers`

### POST /orders

Метод принимает на вход список с данными о заказах в формате json.
Заказы характеризуются весом, районом доставки, временем доставки и ценой.

### GET /orders/{order_id}

Метод возвращает информацию о заказе по его идентификатору.

Информация включает всебя: вес заказа, район доставки, промежутки времени, в которые удобно принять заказ.

### GET /orders

Метод возвращает информацию о всех заказах.

У метода есть параметры `offset` и `limit` для обеспечения постраничной выдачи:
* в случае, если `offset` и `limit` не передаются, считать по умолчанию `offset=0`, `limit=1`
* в случае, если сущностей по заданным `offset` и `limit` не найдено, то необходимо возвращать пустой список `orders`

### POST /orders/complete

Метод отмечает заказ выполненным и принимает 3 параметра:
* id курьера
* id заказа
* время выполнения заказа

В случае, если заказ не найден, был назначен на другого курьера или не назначен вовсе, следует вернуть ошибку 
`HTTP 400 Bad Request`.

В случае успеха возвращается идентификатор завершенного заказа.
Обработчик должен быть идемпотентным.

## Задание 2. Рейтинг курьеров

Команда сервиса решила начать учет заработной платы и рейтинго курьеров.
Для этого необходимо реализовать новый метод `GET /couriers/meta-info/{courier_id}`.

Параметры метода:
* `start_date` - дата начала отсчета рейтинга
* `end_date` - дата конца отсчета рейтинга.

Примером значения параметров может быть `2023-01-20T14:23:05.108766Z`. Таймзона - UTC.

Метод должен возвращать заработанные курьером деньги за заказы и его рейтинг.

**Формула расчета заработка**

Заработок рассчитывается как сумма оплаты за каждый завершенный развоз в период с `start_date` (включая) до 
`end_date` (исключая):

`sum = ∑(cost * C)`

`C`  — коэффициент, зависящий от типа курьера:
* пеший — 2
* велокурьер — 3
* авто — 4

Если курьер не завершил ни одного развоза, то рассчитывать и возвращать заработок не нужно.

**Формула расчета рейтинга**

Рейтинг рассчитывается следующим образом:
((число всех выполненных заказов с `start_date` по `end_date`) / (Количество дней со `start_date` до `end_date`)) * C
C - коэффициент, зависящий от типа курьера:
* пеший = 3
* велокурьер = 2
* авто - 1

Если курьер не завершил ни одного развоза, то рассчитывать и возвращать рейтинг не нужно.

## Задание 3. Rate limiter

Каждый большой сервис с API, открытым из интернета должен ограничивать количество входящих запросов.
Для этого используется rate limiter. Необходимо реализовать такое решение для разрабатываемого сервиса.

Для решения задачи можно написать собственную реализацию или использовать известное готовое решение. 
Сервис должен ограничивать нагрузку в 10 RPS на каждый метод. В случае превышения допустимого количества запросов 
сервис должен отвечать кодом 429.

## Задание 4. Распределение заказов

Сейчас сервис Яндекс Лавка для каждого курьера выбирает один заказ.
Это приводит к том, что курьер может быть не загружен или будет доставлять заказ по удаленному адресу.
Перед началом рабочей смены сервис распределяет заказы между курьерами для минимизации стоимости доставки.

Для этого нам понадобятся реализовать:
* метод распределения заказов `POST /orders/assign`. В общем виде он будет выглядеть так: перед началом рабочего дня 
берем список заказов и распределяем их по доступным курьерам
* метод получения уже распределенных заказов `GET /couriers/assignments`

Для распределения заказов между курьерами учитываются следующие параметры:
* вес заказа
* регион доставки
* стоимость доставки

**Вес заказов**

У каждой из категорий курьеров есть ограничение по весу перевозимого заказа и количества заказов.

| Тип курьера | Максимальный вес | Максимальное количество |
|---|---|---|
| пеший | 10 | 2 |
| велокурьер | 20 | 4 |
| авто | 40 | 7 |

**Регион доставки**

Тип используемого транспорта влияет на количество регионов, которые может посетить курьер при доставке заказов.

| Тип курьера | Количество регионов | Комментарий |
|---|---|---|
| пеший | 1 | Доставка осуществляется только в одном регионе |
| велокурьер | 2 | Доставка будет в двух регионах |
| авто | 3 | Можно выбрать 3 региона |

**Время доставки**

Время доставки складывается из посещения всех точек для вручения заказа в регионе и времени ожидания для вручения заказа.

Время посещения всех точек в одном регионе:

| Тип курьера | 1й заказ | Следующие заказы |
|---|---|---|
| пеший | 25 | 10 |
| велокурьер | 12 | 8 |
| авто | 8 | 4 |

При доставке товара в другом регионе, время рассчитывается также:

| Тип курьера | 1й заказ | Следующие заказы |
|---|---|---|
| велокурьер | 12 | 8 |
| авто | 8 | 4 |

Время доставки ограничено рабочим интервалов. Например, если курьер работает с 10-00 до 12-00 без использования 
транспорта, он может доставить 4 заказа без объединения:

| Время | Номер заказа |
|---|---|
| 10:00 | 1 |
| 10:25 | 2 |
| 10:50 | 3 |
| 11:15 | 4 |

И с объединением заказов, получится доставить больше заказов за то же время:

| Время | Номер заказа |
|---|---|
| 10:00 | [1, 2] |
| 10:35 | [3, 4] |
| 11:10 | [5, 6] |
| 11:45 | [7, 8] |

**Стоимость доставки**

Стоимость доставки при группировке заказов, расчитывается следующим образом:

| Тип курьера | 1й заказ | Следующие заказы |
|---|---|---|
| пеший | 100% | 80% |
| велокурьер | 100% | 80% |
| авто | 100% | 80% |

## Приложение. Как выполнить задание?

1. Сгенерировать ssh-ключ (ссылка на инструкцию)
2. Перейти в [профиль](https://school.yandex.ru/profile/) и ввести в поле открытый ssh-ключ
3. [Вернуться в задачу](https://school.yandex.ru/courses/:id/groups/:id/lessons/:id/tasks/:id/solutions/:id), в комментариях появятся ссылки на 2 репозитория:
    * с тестовым заданием
    * с шаблоном решения

4. Выполнить `git pull` репозитория с тестовым заданием, в нем можно найти более подробные инструкции по выполнению
5. Выполнить `git pull` репозитория с шаблоном решения.
В данном репозитории нужно выполнить задание, сделать `git commit` и отправить результат на сервер `git push`.
После того, как выполнен git push, нужно вернуться в LMS на [страницу с заданием](https://school.yandex.ru/courses/:id/groups/:id/lessons/:id/tasks/:id/solutions/:id)
и нажать кнопку "Отправить на проверку"
